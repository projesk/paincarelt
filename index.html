<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>PainCare LT â€“ Geriatrinio paciento skausmo vertinimas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#4b7bec"/>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{
      --primary:#4b7bec;
      --bg:#f5f5f7;
      --card:#fff;
      --muted:#555;
      --danger:#b00020;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg); color:#222;
    }
    .app{max-width:980px;margin:0 auto;padding:16px 10px 42px}
    h1{font-size:1.55rem;margin:.2rem 0}
    h2{font-size:1.2rem;margin:1rem 0 .5rem}
    h3{font-size:1rem;margin:.7rem 0 .25rem}
    .card{
      background:var(--card); border-radius:var(--radius);
      box-shadow:0 4px 12px rgba(0,0,0,.06);
      padding:14px 16px; margin-top:14px;
    }
    .hint{color:var(--muted);font-size:.92rem}
    .hidden{display:none!important}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .radio-group{display:flex;gap:10px;flex-wrap:wrap}
    .radio-group label{display:inline-flex;align-items:center;gap:6px;cursor:pointer}
    input[type="number"], input[type="text"], textarea{
      width:100%; max-width:220px; padding:8px 10px; border:1px solid #d6d6d6; border-radius:10px;
      font-size:1rem; background:#fff;
    }
    textarea{max-width:100%;min-height:64px}
    .primary-btn,.secondary-btn{
      border-radius:999px; padding:9px 16px; font-size:.95rem; cursor:pointer;
    }
    .primary-btn{background:var(--primary);color:#fff;border:none;box-shadow:0 2px 6px rgba(0,0,0,.18)}
    .secondary-btn{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .muted-btn{background:#f1f2f6;border:1px solid #e4e6ea;color:#333}

    /* Grid eilutÄ—s (PAINAD/PAIC/MMSE lentelÄ—ms) */
    .grid-head,.grid-row{
      display:grid; gap:8px; align-items:flex-start; padding:6px 0; border-bottom:1px solid #eee;
      font-size:.95rem;
    }
    .grid-head{font-weight:600;border-bottom:2px solid #ddd;margin-top:8px;padding-bottom:6px}
    .grid-mmse{grid-template-columns:36px 1.2fr 1.8fr 200px}
    .grid-painad,.grid-paic{grid-template-columns:36px 1.3fr 2fr 210px}

    /* Iowa â€termometrasâ€œ */
    .iowa-row{display:flex;align-items:center;gap:10px}
    .iowa-bar{flex:1;height:24px;border-radius:8px;display:flex;align-items:center;padding-left:8px;font-size:.95rem}
    .iowa-mark{width:6px;height:70%;border-radius:4px;background:rgba(0,0,0,.2);margin-right:6px}
    .iowa-text{white-space:nowrap}
    .iowa-0{background:#d4f8d4} .iowa-1{background:#e6f9c7} .iowa-2{background:#fdf3c4}
    .iowa-3{background:#ffe0b5} .iowa-4{background:#ffc9c9} .iowa-5{background:#ffb3b3} .iowa-6{background:#ff9e9e}

    /* FPS-R veidukai */
    .faces-option{display:inline-flex;align-items:center;gap:8px;background:#f1f2f6;border-radius:10px;padding:6px 10px}
    .faces-option span:first-child{font-size:2.6rem;line-height:1}
    .faces-option .desc{font-size:.9rem}

    /* DVPRS vizualas */
    .dvprs-horizontal{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px}
    .dvprs-item{min-width:170px;border-radius:10px;padding:8px 10px;font-size:.9rem;display:flex;flex-direction:column;align-items:center}
    .dvprs-face{font-size:2rem;margin-bottom:4px}
    .dvprs-mild{background:#e3f9e5} .dvprs-moderate{background:#fff9e3} .dvprs-severe{background:#ffe5e5}

    /* Modal â€“ didelis tekstas pacientui */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none;
      align-items:center; justify-content:center; padding:20px; z-index:50;
    }
    .modal.open{display:flex}
    .modal-card{
      background:#fff; border-radius:16px; max-width:720px; width:100%; padding:24px 20px; text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .modal-card h4{margin:.3rem 0 1rem;font-size:1.1rem;color:#333}
    .modal-text{font-size:2.2rem;line-height:1.35;margin:6px 0 12px}
    .modal-close{margin-top:8px}

    /* Instaliavimo â€bannerisâ€œ */
    #install-banner{position:fixed;left:12px;right:12px;bottom:12px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:10px 12px;display:none;align-items:center;justify-content:space-between;gap:10px;z-index:30}
    #install-banner .txt{font-size:.95rem}
    #install-banner .actions{display:flex;gap:8px}

    /* Mobile tweaks */
    @media (max-width:820px){
      .grid-mmse{grid-template-columns:30px 1fr}
      .grid-mmse .col-3,.grid-mmse .col-4{grid-column: span 2}
      .grid-painad,.grid-paic{grid-template-columns:30px 1fr}
      .grid-painad .col-3,.grid-painad .col-4,
      .grid-paic .col-3,.grid-paic .col-4{grid-column: span 2}
      input[type="number"]{max-width:160px}
      .modal-text{font-size:9vw}
    }
  </style>
</head>
<body>

<div class="app">

  <!-- Install banner -->
  <div id="install-banner">
    <div class="txt">Ä®sidiekite <strong>PainCare LT</strong> Ä¯ telefonÄ….</div>
    <div class="actions">
      <button class="secondary-btn" id="install-btn">Ä®diegti</button>
      <button class="muted-btn" id="install-dismiss">VÄ—liau</button>
    </div>
  </div>

  <!-- PRADINIS -->
  <div id="screen-start" class="card">
    <h1>PainCare LT</h1>
    <p class="hint">
      1 Å¾ingsnis â€“ pasirinkite, kas pildo Ä¯vertinimÄ…<br>
      2 Å¾ingsnis â€“ Ä¯veskite MMSE (arba atlikite testÄ…, jei esate specialistas)<br>
      3 Å¾ingsnis â€“ sistema parinks skales ir pateiks rekomendacijas
    </p>

    <h2>Kas pildo Ä¯vertinimÄ…?</h2>
    <div class="radio-group">
      <label><input type="radio" name="role" value="relative" onclick="setRole('relative')">Artimasis</label>
      <label><input type="radio" name="role" value="hcp" onclick="setRole('hcp')">Sveikatos prieÅ¾iÅ«ros specialistas</label>
    </div>

    <div id="mmse-input-section" class="hidden">
      <hr>
      <h2>1. Ä®veskite MMSE balus</h2>
      <div class="row">
        <input type="number" id="start-mmse" placeholder="0â€“30" min="0" max="30">
        <button class="primary-btn" onclick="handleStartWithMmse()">TÄ™sti</button>
        <button id="btn-mmse-test" class="secondary-btn" style="display:none" onclick="goToMmseForm()">NeÅ¾inau â€“ atlikti MMSE testÄ…</button>
      </div>
    </div>
  </div>

  <!-- MMSE -->
  <div id="screen-mmse" class="hidden card">
    <h2>MMSE â€“ Mini psichikos bÅ«klÄ—s Ä¯vertinimas</h2>
    <p class="hint">Kiekvienam punktui paÅ¾ymÄ—kite <strong>TAIP</strong> (1 balas) arba <strong>NE</strong> (0 balÅ³).
      Jei pasirenkate <strong>NE</strong>, galite (nebÅ«tina) Ä¯raÅ¡yti paciento atsakymÄ… â€“ taÅ¡kai vis tiek nesuteikiami.
    </p>

    <div class="grid-head grid-mmse">
      <div>#</div><div>Punktas</div><div class="col-3">Instrukcija</div><div class="col-4">Balai / Atsakymas</div>
    </div>
    <div id="mmse-form-items"></div>

    <div style="margin-top:10px">
      <button class="primary-btn" onclick="calculateMmseFromForm(true)">ApskaiÄiuoti MMSE ir tÄ™sti</button>
      <button class="secondary-btn" onclick="showScreen('screen-start')">GrÄ¯Å¾ti</button>
    </div>

    <div id="mmse-form-result" class="hidden" style="margin-top:12px;border-left:4px solid var(--primary);padding-left:12px">
      <p id="mmse-form-main"></p>
      <details>
        <summary>PerÅ¾iÅ«rÄ—ti visus atsakymus</summary>
        <div id="mmse-answers-dump" style="margin-top:6px"></div>
      </details>
    </div>

    <p class="hint" style="margin-top:10px">
      Nuoroda Ä¯ lietuviÅ¡kÄ… MMSE PDF:
      <a href="http://www.loravita.lt/formos/MMSE.pdf" target="_blank" rel="noopener">MMSE (lietuviÅ¡ka forma, PDF)</a>
    </p>
  </div>

  <!-- SKALIÅ² EKRANAS (routing pagal MMSE) -->
  <div id="screen-scales" class="hidden">
    <div class="card">
      <h2>2. Skausmo skalÄ—s parinkimas</h2>
      <p id="scale-intro" class="hint"></p>
    </div>

    <!-- 18â€“23 Å¡aka -->
    <div id="branch-18-23" class="card hidden">
      <h3>Lengvi kognityviniai sutrikimai (MMSE 18â€“23)</h3>
      <p class="hint">Ar pacientas geba suprasti paprastÄ… vizualinÄ™ ir Å¾odinÄ™ informacijÄ…?</p>
      <button class="primary-btn" onclick="branch1823('yes')">Taip â€“ vizualinÄ—s / Å¾odinÄ—s skalÄ—s (Iowa, VDS, veidukai, NRS)</button>
      <button class="secondary-btn" onclick="branch1823('no')">Ne â€“ PAINAD skalÄ—</button>
    </div>

    <!-- 0â€“17 Å¡aka -->
    <div id="branch-0-17" class="card hidden">
      <h3>SunkÅ«s sutrikimai (MMSE 0â€“17)</h3>
      <p class="hint">Pasirinkite pagal situacijÄ…:</p>
      <button class="primary-btn" onclick="branch017Quick()">Greitas Ä¯vertinimas â€“ Abbey</button>
      <button class="secondary-btn" onclick="branch017Detailed()">IÅ¡samus â€“ PAIC-15</button>
    </div>

    <div id="branch-0-17-paic" class="card hidden">
      <h3>IÅ¡samus vertinimas</h3>
      <p class="hint">Ar mokate naudoti PAIC-15?</p>
      <button class="primary-btn" onclick="branch017Paic('yes')">Taip â€“ PAIC-15</button>
      <button class="secondary-btn" onclick="branch017Paic('no')">Ne â€“ Abbey</button>
      <p class="hint">PAIC-15 mokymai: <a href="https://paic15.org/en/1" target="_blank" rel="noopener">https://paic15.org/en/1</a></p>
    </div>

    <!-- Paprastos skalÄ—s -->
    <div id="card-simple" class="card hidden">
      <h2>Iowa, Å¾odinÄ—, veidukai, NRS</h2>

      <h3>Iowa Pain Thermometer</h3>
      <p class="hint">Spalvos: Å¾alia â†’ raudona (nuo â€neskaudaâ€œ iki â€labai skaudaâ€œ).</p>
      <div class="radio-group" style="flex-direction:column;gap:6px">
        <label class="iowa-row"><input type="radio" name="iowa-thermo" value="0"><div class="iowa-bar iowa-0"><span class="iowa-mark"></span><span class="iowa-text">0 â€“ NÄ—ra skausmo</span></div></label>
        <label class="iowa-row"><input type="radio" name="iowa-thermo" value="1"><div class="iowa-bar iowa-1"><span class="iowa-mark"></span><span class="iowa-text">1 â€“ Vos juntamas</span></div></label>
        <label class="iowa-row"><input type="radio" name="iowa-thermo" value="2"><div class="iowa-bar iowa-2"><span class="iowa-mark"></span><span class="iowa-text">2 â€“ Lengvas</span></div></label>
        <label class="iowa-row"><input type="radio" name="iowa-thermo" value="3"><div class="iowa-bar iowa-3"><span class="iowa-mark"></span><span class="iowa-text">3 â€“ Vidutinis</span></div></label>
        <label class="iowa-row"><input type="radio" name="iowa-thermo" value="4"><div class="iowa-bar iowa-4"><span class="iowa-mark"></span><span class="iowa-text">4 â€“ Stiprus</span></div></label>
        <label class="iowa-row"><input type="radio" name="iowa-thermo" value="5"><div class="iowa-bar iowa-5"><span class="iowa-mark"></span><span class="iowa-text">5 â€“ Labai stiprus</span></div></label>
        <label class="iowa-row"><input type="radio" name="iowa-thermo" value="6"><div class="iowa-bar iowa-6"><span class="iowa-mark"></span><span class="iowa-text">6 â€“ Smarkiausias Ä¯manomas skausmas</span></div></label>
      </div>

      <hr>
      <h3>Å½odinÄ— skausmo skalÄ— (VDS)</h3>
      <div class="radio-group">
        <label><input type="radio" name="vds" value="0">0 â€“ nÄ—ra</label>
        <label><input type="radio" name="vds" value="1">1 â€“ lengvas</label>
        <label><input type="radio" name="vds" value="2">2 â€“ vidutinis</label>
        <label><input type="radio" name="vds" value="3">3 â€“ stiprus</label>
      </div>

      <hr>
      <h3>VeidukÅ³ skalÄ— (FPS-R)</h3>
      <div class="radio-group">
        <label class="faces-option"><input type="radio" name="faces" value="0"><span>ğŸ™‚</span><span class="desc">NÄ—ra skausmo</span></label>
        <label class="faces-option"><input type="radio" name="faces" value="2"><span>ğŸ˜Š</span><span class="desc">Labai lengvas</span></label>
        <label class="faces-option"><input type="radio" name="faces" value="4"><span>ğŸ˜</span><span class="desc">Lengvas</span></label>
        <label class="faces-option"><input type="radio" name="faces" value="6"><span>ğŸ˜•</span><span class="desc">Vidutinis</span></label>
        <label class="faces-option"><input type="radio" name="faces" value="8"><span>ğŸ˜£</span><span class="desc">Stiprus</span></label>
        <label class="faces-option"><input type="radio" name="faces" value="10"><span>ğŸ˜­</span><span class="desc">Labai stiprus</span></label>
      </div>

      <hr>
      <h3>NRS (0â€“10)</h3>
      <div class="row">
        <input type="range" id="nrs-slider" min="0" max="10" value="0" oninput="document.getElementById('nrs-value').textContent=this.value">
        <span><strong>NRS:</strong> <span id="nrs-value">0</span>/10</span>
        <button class="primary-btn" onclick="summarizeSimpleScales()">ApskaiÄiuoti</button>
      </div>

      <div id="simple-scales-result" class="hidden">
        <p id="simple-scales-main"></p>
        <p id="simple-scales-summary"></p>
        <p id="simple-scales-interpretation" class="hint"></p>
        <p id="simple-scales-warning" class="hint" style="color:var(--danger)"></p>
        <div id="simple-scales-next" class="hidden" style="margin-top:6px">
          <button class="secondary-btn" onclick="goFromSimpleToPainad()">Pereiti Ä¯ PAINAD skalÄ™</button>
        </div>
      </div>
    </div>

    <!-- DVPRS -->
    <div id="card-dvprs" class="card hidden">
      <h2>DVPRS (0â€“10)</h2>
      <p class="hint">Pasirinkite skaiÄiÅ³, veidukÄ… ir apraÅ¡ymÄ…, labiausiai atitinkantÄ¯ skausmÄ….</p>
      <div id="dvprs-options" class="dvprs-horizontal"></div>
      <button class="primary-btn" onclick="calculateDvprs()">SkaiÄiuoti</button>
      <div id="dvprs-result-box" class="hidden">
        <p id="dvprs-result-main"></p>
        <p id="dvprs-result-interpretation" class="hint"></p>
      </div>
    </div>

    <!-- PAINAD -->
    <div id="card-painad" class="card hidden">
      <h2>PAINAD (0â€“10)</h2>
      <p class="hint">StebÄ—kite pacientÄ… ~5 min. Kiekvienai kategorijai: 0â€“2 balai.</p>
      <div class="grid-head grid-painad"><div>#</div><div>Kategorija</div><div class="col-3">PavyzdÅ¾iai</div><div class="col-4">Balai</div></div>
      <div id="painad-items"></div>
      <button class="primary-btn" onclick="calculatePainad()">SkaiÄiuoti PAINAD</button>
      <div id="painad-result-box" class="hidden">
        <p id="painad-result-main"></p>
        <p id="painad-result-interpretation" class="hint"></p>
      </div>
    </div>

    <!-- PAIC-15 -->
    <div id="card-paic" class="card hidden">
      <h2>PAIC-15</h2>
      <p class="hint">0 â€“ nÄ—ra, 1 â€“ Å¡iek tiek, 2 â€“ vidutiniÅ¡kai, 3 â€“ ryÅ¡kiai, X â€“ nevertinta</p>
      <div class="grid-head grid-paic"><div>#</div><div>PoÅ¾ymis</div><div class="col-3">PaaiÅ¡kinimas</div><div class="col-4">Balai</div></div>
      <div id="paic-items"></div>
      <button class="primary-btn" onclick="calculatePaic()">SkaiÄiuoti PAIC</button>
      <div id="paic-result-box" class="hidden">
        <p id="paic-result-main"></p>
        <p id="paic-result-interpretation" class="hint"></p>
      </div>
    </div>

    <!-- Abbey -->
    <div id="card-abbey" class="card hidden">
      <h2>Abbey skausmo skalÄ—</h2>
      <p class="hint">Kiekvienam poÅ¾ymiui: 0 â€“ nÄ—ra, 1 â€“ lengvas, 2 â€“ vidutinis, 3 â€“ ryÅ¡kus</p>
      <div class="grid-head grid-painad"><div>#</div><div>PoÅ¾ymis</div><div class="col-3">PavyzdÅ¾iai</div><div class="col-4">Balai</div></div>
      <div id="abbey-items"></div>
      <h3>Skausmo tipas</h3>
      <div class="radio-group">
        <label><input type="radio" name="abbey-type" value="LÄ—tinis">LÄ—tinis</label>
        <label><input type="radio" name="abbey-type" value="Åªminis">Åªminis</label>
        <label><input type="radio" name="abbey-type" value="Åªminis lÄ—tinio fone">Åªminis lÄ—tinio fone</label>
      </div>
      <button class="primary-btn" onclick="calculateAbbey()">SkaiÄiuoti Abbey</button>
      <div id="abbey-result-box" class="hidden">
        <p id="abbey-result-main"></p>
        <p id="abbey-result-interpretation" class="hint"></p>
      </div>
    </div>

    <!-- Rekomendacijos -->
    <div id="recommend-card" class="card hidden">
      <h2>3. Rekomendacijos pagal skausmÄ…</h2>
      <p id="recommend-main"></p>
      <p id="recommend-extra" class="hint"></p>
      <button class="secondary-btn" onclick="resetApp()">Naujas pacientas</button>
    </div>
  </div>
</div>

<!-- Modal: didelis tekstas â€UÅ½MERKITE AKISâ€œ -->
<div id="bigModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-card">
    <h4 id="modalTitle">Parodykite pacientui</h4>
    <div id="modalText" class="modal-text">UÅ½MERKITE AKIS</div>
    <button class="primary-btn modal-close" onclick="closeModal()">UÅ¾daryti</button>
  </div>
</div>

<script>
/* ---------------- PWA: ServiceWorker + install banner ---------------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js'));
}
let deferredPrompt=null;
const installBanner=document.getElementById('install-banner');
window.addEventListener('beforeinstallprompt',(e)=>{
  e.preventDefault(); deferredPrompt=e;
  installBanner.style.display='flex';
});
document.getElementById('install-btn').addEventListener('click',async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice; deferredPrompt=null;
  installBanner.style.display='none';
});
document.getElementById('install-dismiss').addEventListener('click',()=>installBanner.style.display='none');

/* ---------------- App state ---------------- */
let userRole=null; // 'relative' | 'hcp'
let currentMmseScore=null;
const mmseAnswers=[]; // {idx, id, title, yes, note}

/* ---------------- Role handling ---------------- */
function setRole(role){
  userRole=role;
  const sec=document.getElementById('mmse-input-section');
  const btn=document.getElementById('btn-mmse-test');
  sec.classList.remove('hidden');
  btn.style.display=(role==='hcp')?'inline-block':'none';
}
function showScreen(id){
  ['screen-start','screen-mmse','screen-scales'].forEach(s=>{
    const el=document.getElementById(s);
    if(el) el.classList.toggle('hidden', s!==id);
  });
}

/* ---------------- Start with MMSE value ---------------- */
function handleStartWithMmse(){
  if(!userRole){ alert('Pasirinkite, kas pildo Ä¯vertinimÄ….'); return; }
  const val=Number(document.getElementById('start-mmse').value);
  if(isNaN(val)||val<0||val>30){ alert('Ä®veskite MMSE nuo 0 iki 30.'); return; }
  currentMmseScore=val; routeByMmse(val);
}
function goToMmseForm(){ showScreen('screen-mmse'); }

/* ---------------- MMSE generatorius (TAIP/NE + ne pastaba) ---------------- */
const mmseItems=[
  // Orientacija laike (5)
  {id:'year', t:'Metai', m:'Teisingai pasako, kokie dabar metai.'},
  {id:'season', t:'MetÅ³ laikas', m:'Pavasaris / vasara / ruduo / Å¾iema.'},
  {id:'month', t:'MÄ—nuo', m:'Teisingai nurodo mÄ—nesÄ¯.'},
  {id:'daymonth', t:'MÄ—nesio diena', m:'Teisingai pasako datÄ….'},
  {id:'weekday', t:'SavaitÄ—s diena', m:'Teisingai nurodo savaitÄ—s dienÄ….'},
  // Orientacija vietoje (5)
  {id:'country', t:'Å alis', m:'Teisingai nurodo Å¡alÄ¯.'},
  {id:'region', t:'Apskritis / regionas', m:'Teisingai nurodo regionÄ… / apskritÄ¯.'},
  {id:'city', t:'Miestas', m:'Teisingai nurodo miestÄ….'},
  {id:'institution', t:'Ä®staiga', m:'LigoninÄ—, slaugos namai ir pan.'},
  {id:'ward', t:'Skyrius / palata', m:'Teisingai nurodo skyriÅ³ / palatÄ… / aukÅ¡tÄ….'},
  // Ä®siminimas (3)
  {id:'reg1', t:'Ä®siminimas â€“ Å¾odis 1', m:'IÅ¡kart pakartoja 1-Ä… Å¾odÄ¯ teisingai.'},
  {id:'reg2', t:'Ä®siminimas â€“ Å¾odis 2', m:'IÅ¡kart pakartoja 2-Ä… Å¾odÄ¯ teisingai.'},
  {id:'reg3', t:'Ä®siminimas â€“ Å¾odis 3', m:'IÅ¡kart pakartoja 3-Ä… Å¾odÄ¯ teisingai.'},
  // DÄ—mesys/skaiÄiavimas (5)
  {id:'calc1', t:'100â€“7', m:'ApskaiÄiuoja 93.'},
  {id:'calc2', t:'93â€“7', m:'ApskaiÄiuoja 86.'},
  {id:'calc3', t:'86â€“7', m:'ApskaiÄiuoja 79.'},
  {id:'calc4', t:'79â€“7', m:'ApskaiÄiuoja 72.'},
  {id:'calc5', t:'72â€“7', m:'ApskaiÄiuoja 65.'},
  // Atsiminimas (3)
  {id:'rec1', t:'Prisimena Å¾odÄ¯ 1', m:'Po keliÅ³ min. prisimena 1-Ä… Å¾odÄ¯.'},
  {id:'rec2', t:'Prisimena Å¾odÄ¯ 2', m:'Po keliÅ³ min. prisimena 2-Ä… Å¾odÄ¯.'},
  {id:'rec3', t:'Prisimena Å¾odÄ¯ 3', m:'Po keliÅ³ min. prisimena 3-Ä… Å¾odÄ¯.'},
  // Kalba â€“ Ä¯vardijimas (2)
  {id:'name-watch', t:'Ä®vardija laikrodÄ¯', m:'ParodÅ¾ius laikrodÄ¯, teisingai Ä¯vardija.'},
  {id:'name-pencil', t:'Ä®vardija pieÅ¡tukÄ…', m:'ParodÅ¾ius pieÅ¡tukÄ…, teisingai Ä¯vardija.'},
  // Kalba â€“ kartojimas (1)
  {id:'repeat', t:'Pakartoja sakinÄ¯', m:'Teisingai pakartoja pateiktÄ… sakinÄ¯.'},
  // Komandos 3 Å¾ingsniÅ³ (3)
  {id:'cmd1', t:'Paimti lapÄ…', m:'Atlieka 1-Ä… komandÄ….'},
  {id:'cmd2', t:'Sulankstyti per pusÄ™', m:'Atlieka 2-Ä… komandÄ….'},
  {id:'cmd3', t:'PadÄ—ti ant grindÅ³', m:'Atlieka 3-iÄ… komandÄ….'},
  // Skaitymas â€“ DIDELIS TEKSTAS
  {id:'close-eyes', t:'Perskaito ir Ä¯vykdo â€UÅ½MERKITE AKISâ€œ',
    m:'Paspauskite â€Rodyti dideliu Å¡riftuâ€œ ir parodykite pacientui.',
    bigText:'UÅ½MERKITE AKIS'},
  // RaÅ¡ymas ir kopijavimas
  {id:'write', t:'ParaÅ¡o sakinÄ¯', m:'ParaÅ¡o prasmingÄ… sakinÄ¯.'},
  {id:'copy', t:'Nukopijuoja figÅ«rÄ…', m:'Nukopijuoja pavyzdinÄ™ figÅ«rÄ… (2 persidengiantys penkiakampiai).'}
];
const mmseContainer=document.getElementById('mmse-form-items');
(function renderMMSE(){
  let idx=1;
  mmseItems.forEach(it=>{
    const row=document.createElement('div');
    row.className='grid-row grid-mmse';
    row.innerHTML=`
      <div>${idx}</div>
      <div><strong>${it.t}</strong></div>
      <div class="col-3">
        ${it.m || ''}
        ${it.bigText ? `<div><button class="secondary-btn" type="button" onclick="showModal('${(it.bigText||'').replace(/'/g,"\\'")}')">Rodyti dideliu Å¡riftu</button></div>`:''}
      </div>
      <div class="col-4">
        <div class="radio-group">
          <label><input type="radio" name="mmse-${it.id}" value="1">TAIP (1)</label>
          <label><input type="radio" name="mmse-${it.id}" value="0">NE (0)</label>
        </div>
        <div class="ne-note hidden">
          <textarea placeholder="(nebÅ«tina) Ä®raÅ¡ykite paciento atsakymÄ…"></textarea>
        </div>
      </div>`;
    mmseContainer.appendChild(row);

    // parodyti/ slÄ—pti â€NEâ€œ pastabos laukÄ…
    const radios=row.querySelectorAll(`input[name="mmse-${it.id}"]`);
    const note=row.querySelector('.ne-note');
    radios.forEach(r=>{
      r.addEventListener('change',()=>{
        if(r.value==='0' && r.checked) note.classList.remove('hidden');
        else note.classList.add('hidden');
      });
    });
    idx++;
  });
})();

/* Modal funkcijos */
function showModal(text){
  document.getElementById('modalText').textContent=text||'TEKSTAS';
  document.getElementById('bigModal').classList.add('open');
}
function closeModal(){ document.getElementById('bigModal').classList.remove('open'); }
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });

/* SkaiÄiuoti MMSE + rodyti atsakymus */
function calculateMmseFromForm(continueNext){
  mmseAnswers.length=0; let total=0; let idx=1;
  mmseItems.forEach(it=>{
    const sel=document.querySelector(`input[name="mmse-${it.id}"]:checked`);
    const yes = sel ? Number(sel.value)===1 : false;
    const noteEl= document.querySelector(`input[name="mmse-${it.id}"]:checked`) ?
                  document.querySelector(`input[name="mmse-${it.id}"]:checked`).closest('.col-4').querySelector('.ne-note textarea') : null;
    const note = (sel && sel.value==='0' && noteEl) ? noteEl.value.trim() : '';
    if(yes) total+=1;
    mmseAnswers.push({idx, id:it.id, title:it.t, yes, note});
    idx++;
  });
  currentMmseScore=total;

  // Rezultato santrauka
  document.getElementById('mmse-form-main').innerHTML =
    `<strong>MMSE suma: ${total} balai.</strong> (0â€“17: sunkÅ«s; 18â€“23: lengvi; 24â€“30: kognityviniÅ³ sutrikimÅ³ nÄ—ra / minimalÅ«s)`;
  // Pilni atsakymai
  const dump=document.getElementById('mmse-answers-dump');
  dump.innerHTML = mmseAnswers.map(a=>{
    const yn = a.yes ? 'TAIP (1)' : 'NE (0)';
    const note = (!a.yes && a.note) ? `<div class="hint">Atsakymas: ${a.note}</div>` : '';
    return `<div style="padding:6px 0;border-bottom:1px dashed #e5e7eb">
      <strong>${a.idx}.</strong> ${a.title}<br>${yn} ${note}
    </div>`;
  }).join('');
  document.getElementById('mmse-form-result').classList.remove('hidden');

  if(continueNext) routeByMmse(total);
}

/* ---------------- Routing pagal MMSE ---------------- */
function routeByMmse(score){
  const intro=document.getElementById('scale-intro');
  ['card-simple','card-dvprs','card-painad','card-paic','card-abbey',
   'recommend-card','branch-18-23','branch-0-17','branch-0-17-paic']
   .forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.add('hidden'); });

  if(score>=24){
    intro.textContent=`MMSE ${score} â€“ kognityviniÅ³ sutrikimÅ³ nÄ—ra. Rekomenduojama DVPRS skalÄ—.`;
    document.getElementById('card-dvprs').classList.remove('hidden');
  }else if(score>=18){
    intro.textContent=`MMSE ${score} â€“ lengvi sutrikimai. Ä®vertinkite, ar pacientas supranta vizualinÄ™/Å¾odinÄ™ informacijÄ….`;
    document.getElementById('branch-18-23').classList.remove('hidden');
  }else{
    intro.textContent=`MMSE ${score} â€“ sunkÅ«s sutrikimai. Rekomenduojama Abbey arba PAIC-15 skalÄ—.`;
    document.getElementById('branch-0-17').classList.remove('hidden');
  }
  showScreen('screen-scales');
}
function branch1823(opt){
  document.getElementById('card-simple').classList.add('hidden');
  document.getElementById('card-painad').classList.add('hidden');
  if(opt==='yes') document.getElementById('card-simple').classList.remove('hidden');
  else document.getElementById('card-painad').classList.remove('hidden');
}
function branch017Quick(){
  document.getElementById('branch-0-17-paic').classList.add('hidden');
  document.getElementById('card-paic').classList.add('hidden');
  document.getElementById('card-abbey').classList.remove('hidden');
}
function branch017Detailed(){ document.getElementById('branch-0-17-paic').classList.remove('hidden'); }
function branch017Paic(opt){
  document.getElementById('card-paic').classList.add('hidden');
  document.getElementById('card-abbey').classList.add('hidden');
  if(opt==='yes') document.getElementById('card-paic').classList.remove('hidden');
  else document.getElementById('card-abbey').classList.remove('hidden');
}

/* ---------------- Paprastos skalÄ—s (vidurkis, NRS dvigubas) ---------------- */
function summarizeSimpleScales(){
  const iowaSel=document.querySelector('input[name="iowa-thermo"]:checked');
  const vdsSel=document.querySelector('input[name="vds"]:checked');
  const facesSel=document.querySelector('input[name="faces"]:checked');
  const nrsVal=Number(document.getElementById('nrs-slider').value);

  document.getElementById('simple-scales-main').innerHTML =
    `<strong>Iowa:</strong> ${(iowaSel?iowaSel.parentElement.textContent.trim():'â€“')}<br>
     <strong>VDS:</strong> ${(vdsSel?vdsSel.parentElement.textContent.trim():'â€“')}<br>
     <strong>Veidukai (FPS-R):</strong> ${(facesSel?facesSel.value:'â€“')}<br>
     <strong>NRS:</strong> ${nrsVal}/10`;

  const vals=[];
  if(iowaSel) vals.push(Number(iowaSel.value)*(10/6));
  if(vdsSel)  vals.push(Number(vdsSel.value)*(10/3));
  if(facesSel) vals.push(Number(facesSel.value));
  vals.push(nrsVal,nrsVal); // NRS â€“ dvigubas svoris

  const minVal=Math.min(...vals), maxVal=Math.max(...vals);
  const avg=vals.reduce((a,b)=>a+b,0)/vals.length;
  const combinedScore=Math.round(avg);

  let levelKey='none';
  if(combinedScore>=7) levelKey='severe';
  else if(combinedScore>=4) levelKey='moderate';
  else if(combinedScore>=1) levelKey='mild';

  document.getElementById('simple-scales-summary').textContent =
    `Apibendrintas skausmo intensyvumas (0â€“10, vidurkis pagal visas skales, NRS turi didesnÄ¯ svorÄ¯): apie ${combinedScore}/10.`;
  document.getElementById('simple-scales-interpretation').textContent =
    'Jei skalÄ—s labai iÅ¡siskiria, pakartokite vertinimÄ… ir apsvarstykite PAINAD.';

  const warn=document.getElementById('simple-scales-warning');
  const next=document.getElementById('simple-scales-next');
  warn.textContent=''; next.classList.add('hidden');
  if(maxVal-minVal>=4){
    warn.textContent=`Ä®SPÄ–JIMAS: skaliÅ³ rezultatai labai skiriasi (nuo ${minVal.toFixed(1)} iki ${maxVal.toFixed(1)}). Rekomenduojama PAINAD.`;
    next.classList.remove('hidden');
  }
  document.getElementById('simple-scales-result').classList.remove('hidden');
  showRecommendations(levelKey);
}
function goFromSimpleToPainad(){
  const el=document.getElementById('card-painad');
  el.classList.remove('hidden'); el.scrollIntoView({behavior:'smooth',block:'start'});
}

/* ---------------- DVPRS ---------------- */
const dvprsItems=[{s:0,t:'NÄ—ra skausmo'},{s:1,t:'Vos jauÄiamas'},{s:2,t:'Labai lengvas'},{s:3,t:'Lengvas'},
{s:4,t:'Vidutinis'},{s:5,t:'Vidutinis, trukdantis'},{s:6,t:'Riboja veiklÄ…'},{s:7,t:'Stiprus'},
{s:8,t:'Labai stiprus'},{s:9,t:'Beveik nepakeliamas'},{s:10,t:'Blogiausias Ä¯sivaizduojamas'}];
const dvprsFaces=['ğŸ™‚','ğŸ™‚','ğŸ™‚','ğŸ™‚','ğŸ˜','ğŸ˜','ğŸ˜•','ğŸ˜£','ğŸ˜«','ğŸ˜­','ğŸ˜­'];
const dvprsContainer=document.getElementById('dvprs-options');
dvprsItems.forEach(i=>{
  const div=document.createElement('div');
  const cls=i.s<=3?'dvprs-mild':i.s<=6?'dvprs-moderate':'dvprs-severe';
  div.className=`dvprs-item ${cls}`;
  div.innerHTML=`<span class="dvprs-face">${dvprsFaces[i.s]}</span>
    <input type="radio" name="dvprs-score" value="${i.s}">
    <span><strong>${i.s}</strong><br>${i.t}</span>`;
  dvprsContainer.appendChild(div);
});
function calculateDvprs(){
  const sel=document.querySelector('input[name="dvprs-score"]:checked');
  if(!sel){alert('Pasirinkite DVPRS balÄ….');return;}
  const v=Number(sel.value);
  let k='none'; if(v>=7)k='severe'; else if(v>=4)k='moderate'; else if(v>=1)k='mild';
  document.getElementById('dvprs-result-main').innerHTML=`<strong>DVPRS:</strong> ${v} â€“ ${dvprsItems[v].t}`;
  document.getElementById('dvprs-result-interpretation').textContent='Pagal Å¡Ä¯ balÄ… parenkamas skausmo malÅ¡inimo intensyvumas.';
  document.getElementById('dvprs-result-box').classList.remove('hidden');
  showRecommendations(k);
}

/* ---------------- PAINAD ---------------- */
const painadItems=[
 {id:'breath',i:1,t:'KvÄ—pavimas',m0:'0 â€“ normalus',m1:'1 â€“ retkarÄiais apsunkintas',m2:'2 â€“ ryÅ¡kiai apsunkintas'},
 {id:'negvoc',i:2,t:'Neigiama vokalizacija',m0:'0 â€“ nÄ—ra',m1:'1 â€“ dejuoja, pÅ«kÅ¡Äia, kalba Å¾emu tonu, negatyviai',m2:'2 â€“ Å¡aukia / verkia'},
 {id:'face',i:3,t:'Veido iÅ¡raiÅ¡ka',m0:'0 â€“ neutrali / Å¡ypsosi',m1:'1 â€“ liÅ«dna, susiraukusi',m2:'2 â€“ grimasa'},
 {id:'body',i:4,t:'KÅ«no kalba',m0:'0 â€“ atsipalaidavÄ™s',m1:'1 â€“ Ä¯temptas, nerimastingas',m2:'2 â€“ sustingÄ™s, ginasi'},
 {id:'console',i:5,t:'Raminamumas',m0:'0 â€“ nereikia raminti',m1:'1 â€“ nusiramina balsu/prisilietimu',m2:'2 â€“ nepavyksta nuraminti'}
];
const painadContainer=document.getElementById('painad-items');
painadItems.forEach(p=>{
  const row=document.createElement('div'); row.className='grid-row grid-painad';
  row.innerHTML=`<div>${p.i}</div><div><strong>${p.t}</strong></div>
  <div class="col-3">${p.m0}<br>${p.m1}<br>${p.m2}</div>
  <div class="col-4"><div class="radio-group">
    <label><input type="radio" name="painad-${p.id}" value="0">0</label>
    <label><input type="radio" name="painad-${p.id}" value="1">1</label>
    <label><input type="radio" name="painad-${p.id}" value="2">2</label>
  </div></div>`;
  painadContainer.appendChild(row);
});
function calculatePainad(){
  let total=0;
  painadItems.forEach(p=>{
    const sel=document.querySelector(`input[name="painad-${p.id}"]:checked`);
    if(sel) total+=Number(sel.value);
  });
  let k='none'; if(total>=7)k='severe'; else if(total>=4)k='moderate'; else if(total>=1)k='mild';
  document.getElementById('painad-result-main').innerHTML=`<strong>PAINAD:</strong> ${total}/10`;
  document.getElementById('painad-result-interpretation').textContent='0 â€“ nÄ—ra, 1â€“3 â€“ lengvas, 4â€“6 â€“ vidutinis, 7â€“10 â€“ stiprus skausmas.';
  document.getElementById('painad-result-box').classList.remove('hidden');
  showRecommendations(k);
}

/* ---------------- PAIC-15 ---------------- */
const paicItems=[
  {id:'1',t:'Suraukta kakta'},{id:'2',t:'Primerktos akys'},{id:'3',t:'Pakelta virÅ¡utinÄ— lÅ«pa'},
  {id:'4',t:'Praveriama burna'},{id:'5',t:'Ä®tempta veido iÅ¡raiÅ¡ka'},{id:'6',t:'SustabarÄ—jimas'},
  {id:'7',t:'Apsauginiai judesiai'},{id:'8',t:'PrieÅ¡inimasis prieÅ¾iÅ«rai'},{id:'9',t:'Trinimas / masaÅ¾avimas'},
  {id:'10',t:'Nerimastingumas'},{id:'11',t:'Skausmo Å¾odÅ¾iai'},{id:'12',t:'Å aukimas'},
  {id:'13',t:'Dejavimas / stenÄ—jimas'},{id:'14',t:'MurmÄ—jimas'},{id:'15',t:'Skundimasis'}
];
const paicContainer=document.getElementById('paic-items');
let pIdx=1;
paicItems.forEach(i=>{
  const row=document.createElement('div'); row.className='grid-row grid-paic';
  row.innerHTML=`<div>${pIdx++}</div><div><strong>${i.t}</strong></div>
  <div class="col-3">StebÄ—kite poÅ¾ymÄ¯ ir Ä¯vertinkite 0â€“3, X â€“ nevertinta</div>
  <div class="col-4"><div class="radio-group">
    <label><input type="radio" name="paic-${i.id}" value="0">0</label>
    <label><input type="radio" name="paic-${i.id}" value="1">1</label>
    <label><input type="radio" name="paic-${i.id}" value="2">2</label>
    <label><input type="radio" name="paic-${i.id}" value="3">3</label>
    <label><input type="radio" name="paic-${i.id}" value="x">X</label>
  </div></div>`;
  paicContainer.appendChild(row);
});
function calculatePaic(){
  let total=0, notScored=0;
  paicItems.forEach(i=>{
    const sel=document.querySelector(`input[name="paic-${i.id}"]:checked`);
    if(!sel||sel.value==='x'){notScored++;return;}
    total+=Number(sel.value);
  });
  let k='none', txt='';
  if(total<=5){txt='0â€“5 â€“ maÅ¾ai Ä¯rodymÅ³ apie skausmÄ….';}
  else if(total<=15){txt='6â€“15 â€“ galimas lengvas skausmas.'; k='mild';}
  else if(total<=30){txt='16â€“30 â€“ galimas vidutinio intensyvumo skausmas.'; k='moderate';}
  else {txt='31â€“45 â€“ galimas stiprus skausmas.'; k='severe';}
  document.getElementById('paic-result-main').innerHTML=`<strong>PAIC suma:</strong> ${total}/45`;
  document.getElementById('paic-result-interpretation').innerHTML=txt+` NevertintÅ³/X: ${notScored}.`;
  document.getElementById('paic-result-box').classList.remove('hidden');
  showRecommendations(k);
}

/* ---------------- Abbey ---------------- */
const abbeyItems=[
  {id:'v1',i:1,t:'Vokalizacija'},{id:'v2',i:2,t:'Veido iÅ¡raiÅ¡ka'},{id:'v3',i:3,t:'KÅ«no kalba'},
  {id:'v4',i:4,t:'Elgesio pokyÄiai'},{id:'v5',i:5,t:'Fiziologiniai pokyÄiai'},{id:'v6',i:6,t:'Oda / fiziniai pakitimai'}
];
const abbeyContainer=document.getElementById('abbey-items');
abbeyItems.forEach(a=>{
  const row=document.createElement('div'); row.className='grid-row grid-painad';
  row.innerHTML=`<div>${a.i}</div><div><strong>${a.t}</strong></div>
  <div class="col-3">0 â€“ nÄ—ra, 1 â€“ lengvi, 2 â€“ vidutiniai, 3 â€“ ryÅ¡kÅ«s</div>
  <div class="col-4"><div class="radio-group">
    <label><input type="radio" name="abbey-${a.id}" value="0">0</label>
    <label><input type="radio" name="abbey-${a.id}" value="1">1</label>
    <label><input type="radio" name="abbey-${a.id}" value="2">2</label>
    <label><input type="radio" name="abbey-${a.id}" value="3">3</label>
  </div></div>`;
  abbeyContainer.appendChild(row);
});
function calculateAbbey(){
  let sum=0;
  abbeyItems.forEach(a=>{
    const sel=document.querySelector(`input[name="abbey-${a.id}"]:checked`);
    if(sel) sum+=Number(sel.value);
  });
  let k='none', txt='';
  if(sum<=2){txt='0â€“2 â€“ skausmo nÄ—ra.';}
  else if(sum<=7){txt='3â€“7 â€“ lengvas skausmas.'; k='mild';}
  else if(sum<=13){txt='8â€“13 â€“ vidutinio stiprumo skausmas.'; k='moderate';}
  else {txt='14+ â€“ stiprus skausmas.'; k='severe';}
  const typeSel=document.querySelector('input[name="abbey-type"]:checked');
  const pType= typeSel ? typeSel.value : 'nepasirinkta';
  document.getElementById('abbey-result-main').innerHTML=`<strong>Abbey suma:</strong> ${sum}/18`;
  document.getElementById('abbey-result-interpretation').innerHTML=txt+`<br>Skausmo tipas: ${pType}.`;
  document.getElementById('abbey-result-box').classList.remove('hidden');
  showRecommendations(k);
}

/* ---------------- Rekomendacijos + reset ---------------- */
function showRecommendations(level){
  const main=document.getElementById('recommend-main');
  const extra=document.getElementById('recommend-extra');
  const card=document.getElementById('recommend-card');
  if(level==='none'){ main.textContent='Skausmo nÄ—ra arba minimalus.';
    extra.textContent='TÄ™skite stebÄ—senÄ…; pakartokite pagal klinikinÄ™ situacijÄ….'; }
  else if(level==='mild'){ main.textContent='Lengvas skausmas.';
    extra.textContent='DaÅ¾nai pakanka nefarmakologiniÅ³ priemoniÅ³ ir bazinio analgetiko (paracetamolis â€“ jei yra gydytojo ord.).'; }
  else if(level==='moderate'){ main.textContent='Vidutinio stiprumo skausmas.';
    extra.textContent='DaÅ¾nai reikalingas kombinuotas gydymas (paracetamolis + NVNU ar kitas vaistas pagal gydytojo ord.), vertinti efektÄ… po 30â€“60 min.'; }
  else { main.textContent='Stiprus skausmas.';
    extra.textContent='Reikalingas intensyvus skausmo malÅ¡inimas (galimi parenteraliniai analgetikai, opioidai pagal gydytojo ord.) ir daÅ¾na kontrolÄ—.'; }
  card.classList.remove('hidden');
}
function resetApp(){ window.location.reload(); }
</script>
</body>
</html>

